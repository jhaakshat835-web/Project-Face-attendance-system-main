<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Register Student</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f8f9fc; /* Light Gray Background */
            color: #5a5c69;
        }

        /* Navbar Styling */
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15);
        }
        .navbar-brand {
            color: #4e73df !important;
            font-weight: 700;
        }

        /* Cards Styling */
        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.15);
        }
        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            font-weight: bold;
            color: #4e73df;
        }

        /* Camera Box Styling */
        .video-wrapper {
            width: 100%;
            background-color: #000;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        video {
            width: 100%;
            display: block;
        }

        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }
        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2653d4;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand navbar-light topbar mb-4 static-top shadow">
        <a class="navbar-brand" href="#">
            <i class="fas fa-user-plus"></i> Capture Students
        </a>
        <div class="ml-auto">
            <a href="/" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> Back to Index
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            
            <div class="col-lg-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-camera"></i> Live Camera
                        </h6>
                    </div>
                    <div class="card-body text-center d-flex flex-column justify-content-center">
                        <div class="video-wrapper mb-3">
                            <video id="video" autoplay muted></video>
                        </div>
                        <p class="small text-muted mb-0">Please keep your face centered.</p>
                        
                        <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
                        <img id="imagePreview" src="" alt="Preview" style="display:none; width: 100%; margin-top: 10px; border-radius: 5px; border: 2px solid #4e73df;">
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Student Details</h6>
                    </div>
                    <div class="card-body">
                        
                        <form id="registrationForm" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            
                            <div class="form-group">
                                <label class="small mb-1 font-weight-bold">Full Name</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="Enter full name" required>
                            </div>

                            <div class="form-group">
                                <label class="small mb-1 font-weight-bold">Email Address</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="student@college.edu" required>
                            </div>

                            <div class="form-group">
                                <label class="small mb-1 font-weight-bold">Registration Number</label>
                                <input type="text" class="form-control" id="registration_number" name="registration_number" placeholder="Ex: 0123CS..." required>
                            </div>

                            <div class="form-group">
                                <label class="small mb-1 font-weight-bold">Branch</label>
                                <select class="form-control" id="branch" name="branch" required>
                                    <option value="">-- Select Branch --</option>
                                    <option value="CSE">Computer Science (CSE)</option>
                                    <option value="CHE">Chemical Engineering</option>
                                    <option value="BCA">Bachelor of Computer Applications (BCA)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="small mb-1 font-weight-bold">Year</label>
                                <select class="form-control" id="year" name="year" required>
                                    <option value="">-- Select Year --</option>
                                    <option value="1st Year">First Year</option>
                                    <option value="2nd Year">Second Year</option>
                                    <option value="3rd Year">Third Year</option>
                                    <option value="4th Year">Fourth Year</option>
                                </select>
                            </div>

                            <input type="hidden" id="image_data" name="image_data">

                            <hr>
                            
                            <button type="submit" class="btn btn-primary btn-block btn-lg">
                                <i class="fas fa-check-circle"></i> Capture & Register
                            </button>

                        </form>
                        </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const imageDataInput = document.getElementById("image_data");
        const registrationForm = document.getElementById("registrationForm");
        const imagePreview = document.getElementById("imagePreview");

        // Camera Start Logic
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                video.srcObject = stream;
                // 'muted' helps prevent feedback loops if audio was involved, though not strictly needed for video only
                video.play();
            })
            .catch((err) => {
                console.error("Camera access error: ", err);
                alert("Unable to access camera. Please allow permission.");
            });

        // Form Submit Logic
        registrationForm.addEventListener("submit", function (event) {
            event.preventDefault(); // Stop default submit to capture image first

            if (video.readyState >= 2) {
                // Draw video frame to canvas
                const context = canvas.getContext("2d");
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert to data URL
                const dataURL = canvas.toDataURL("image/jpeg");
                
                // Put data into hidden input
                imageDataInput.value = dataURL;
                
                // Show preview (Optional visual feedback)
                imagePreview.src = dataURL;
                imagePreview.style.display = "block";

                // Submit form after a tiny delay
                setTimeout(() => {
                    registrationForm.submit();
                }, 100);
            } else {
                alert("Video is not ready yet. Please wait a moment and try again.");
            }
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>